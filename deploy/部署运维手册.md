# ğŸš€ Vue + Express é¡¹ç›®éƒ¨ç½²è¿ç»´æ‰‹å†Œ

> æœ¬æ–‡æ¡£è®°å½•äº†å®Œæ•´çš„éƒ¨ç½²æµç¨‹ï¼Œé€‚ç”¨äº Debian/Ubuntu æœåŠ¡å™¨ + Nginx + PM2 çš„éƒ¨ç½²æ–¹æ¡ˆ

---

## ğŸ“‹ ç›®å½•

1. [æœåŠ¡å™¨ç¯å¢ƒå‡†å¤‡](#1-æœåŠ¡å™¨ç¯å¢ƒå‡†å¤‡)
2. [é¡¹ç›®æ‰“åŒ…](#2-é¡¹ç›®æ‰“åŒ…)
3. [ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨](#3-ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨)
4. [æœåŠ¡å™¨é…ç½®](#4-æœåŠ¡å™¨é…ç½®)
5. [Nginx é…ç½®](#5-nginx-é…ç½®)
6. [å¯†ç ä¿æŠ¤é…ç½®](#6-å¯†ç ä¿æŠ¤é…ç½®)
7. [å¸¸ç”¨è¿ç»´å‘½ä»¤](#7-å¸¸ç”¨è¿ç»´å‘½ä»¤)
8. [æ•…éšœæ’æŸ¥](#8-æ•…éšœæ’æŸ¥)

---

## 1. æœåŠ¡å™¨ç¯å¢ƒå‡†å¤‡

### 1.1 å®‰è£… Node.js 20

```bash
curl -fsSL https://deb.nodesource.com/setup_20.x | bash - && apt-get install -y nodejs
```

éªŒè¯å®‰è£…ï¼š
```bash
node -v   # åº”æ˜¾ç¤º v20.x.x
npm -v    # åº”æ˜¾ç¤º 10.x.x
```

### 1.2 å®‰è£… PM2ï¼ˆè¿›ç¨‹ç®¡ç†å™¨ï¼‰

```bash
npm install -g pm2
```

### 1.3 åˆ›å»ºé¡¹ç›®ç›®å½•

```bash
mkdir -p /var/www/rogueCultivator
```

---

## 2. é¡¹ç›®æ‰“åŒ…

åœ¨æœ¬åœ°å¼€å‘æœºå™¨ä¸Šæ‰§è¡Œï¼š

### 2.1 å‰ç«¯æ‰“åŒ…

```bash
cd frontend
npm run build
```

æ‰“åŒ…åç”Ÿæˆ `frontend/dist/` ç›®å½•

### 2.2 åç«¯æ‰“åŒ…

```bash
cd backend
npm run build
```

æ‰“åŒ…åç”Ÿæˆ `backend/dist/` ç›®å½•

### 2.3 åˆ›å»ºç”Ÿäº§ç¯å¢ƒé…ç½®

åˆ›å»º `frontend/.env.production`ï¼š
```env
VITE_API_BASE_URL=/api
```

åˆ›å»º `backend/.env.production`ï¼š
```env
NODE_ENV=production
PORT=5000
JWT_SECRET=ä½ çš„å®‰å…¨éšæœºå­—ç¬¦ä¸²
JWT_EXPIRES_IN=7d
CORS_ORIGIN=https://ä½ çš„åŸŸå.com
DATABASE_URL=file:./data/prod.db
```

---

## 3. ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨

### 3.1 ä½¿ç”¨ SCP ä¸Šä¼ 

åœ¨æœ¬åœ° Windows CMD æ‰§è¡Œï¼š

```cmd
# ä¸Šä¼ å‰ç«¯
scp -r E:\code\rogueCultivator\frontend\dist root@æœåŠ¡å™¨IP:/var/www/rogueCultivator/frontend/

# ä¸Šä¼ åç«¯
scp -r E:\code\rogueCultivator\backend\dist root@æœåŠ¡å™¨IP:/var/www/rogueCultivator/backend/
scp E:\code\rogueCultivator\backend\package.json root@æœåŠ¡å™¨IP:/var/www/rogueCultivator/backend/
scp E:\code\rogueCultivator\backend\package-lock.json root@æœåŠ¡å™¨IP:/var/www/rogueCultivator/backend/
scp -r E:\code\rogueCultivator\backend\prisma root@æœåŠ¡å™¨IP:/var/www/rogueCultivator/backend/
```

### 3.2 æœåŠ¡å™¨ä¸Šçš„ç›®å½•ç»“æ„

```
/var/www/rogueCultivator/
â”œâ”€â”€ frontend/
â”‚   â””â”€â”€ dist/           # å‰ç«¯é™æ€æ–‡ä»¶
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ dist/           # åç«¯ç¼–è¯‘åçš„ JS
â”‚   â”œâ”€â”€ prisma/         # Prisma schema
â”‚   â”œâ”€â”€ data/           # SQLite æ•°æ®åº“ç›®å½•
â”‚   â”œâ”€â”€ node_modules/   # ä¾èµ–
â”‚   â”œâ”€â”€ package.json
â”‚   â””â”€â”€ .env            # ç”Ÿäº§ç¯å¢ƒé…ç½®
â””â”€â”€ deploy/             # éƒ¨ç½²é…ç½®æ–‡ä»¶
```

---

## 4. æœåŠ¡å™¨é…ç½®

### 4.1 å®‰è£…åç«¯ä¾èµ–

```bash
cd /var/www/rogueCultivator/backend
npm install --production
```

### 4.2 é…ç½®ç¯å¢ƒå˜é‡

```bash
# å¤åˆ¶å¹¶ç¼–è¾‘é…ç½®
nano /var/www/rogueCultivator/backend/.env
```

å¿…é¡»ä¿®æ”¹çš„é…ç½®ï¼š
- `JWT_SECRET`: æ”¹ä¸ºå®‰å…¨çš„éšæœºå­—ç¬¦ä¸²
- `CORS_ORIGIN`: æ”¹ä¸ºä½ çš„åŸŸåï¼Œå¦‚ `https://aipr0.com`

ç”Ÿæˆå®‰å…¨çš„ JWT_SECRETï¼š
```bash
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

### 4.3 åˆå§‹åŒ–æ•°æ®åº“

```bash
cd /var/www/rogueCultivator/backend
mkdir -p data
npx prisma generate
npx prisma db push
```

### 4.4 ä½¿ç”¨ PM2 å¯åŠ¨åç«¯

åˆ›å»º PM2 é…ç½®æ–‡ä»¶ `/var/www/rogueCultivator/ecosystem.config.js`ï¼š

```javascript
module.exports = {
  apps: [{
    name: 'rogue-cultivator-backend',
    script: 'dist/server.js',
    cwd: '/var/www/rogueCultivator/backend',
    instances: 1,
    exec_mode: 'fork',
    env: {
      NODE_ENV: 'production',
      PORT: 5000
    },
    log_date_format: 'YYYY-MM-DD HH:mm:ss',
    error_file: '/var/log/pm2/rogue-cultivator-error.log',
    out_file: '/var/log/pm2/rogue-cultivator-out.log',
    max_memory_restart: '500M'
  }]
}
```

å¯åŠ¨æœåŠ¡ï¼š
```bash
cd /var/www/rogueCultivator
pm2 start ecosystem.config.js
pm2 save
pm2 startup
```

---

## 5. Nginx é…ç½®

### 5.1 åˆ›å»ºç«™ç‚¹é…ç½®

```bash
nano /etc/nginx/conf.d/ä½ çš„åŸŸå.conf
```

### 5.2 HTTP é…ç½®ï¼ˆæ—  SSLï¼‰

```nginx
server {
    listen 80;
    server_name ä½ çš„åŸŸå.com;

    # å‰ç«¯é™æ€æ–‡ä»¶
    location / {
        root /var/www/rogueCultivator/frontend/dist;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    # åç«¯ API ä»£ç†
    location /api {
        proxy_pass http://127.0.0.1:5000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### 5.3 HTTPS é…ç½®ï¼ˆæœ‰ SSL è¯ä¹¦ï¼‰

```nginx
server {
    listen 443 ssl;
    server_name ä½ çš„åŸŸå.com www.ä½ çš„åŸŸå.com;
    
    ssl_certificate /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;
    ssl_protocols TLSv1.2 TLSv1.3;

    # å‰ç«¯é™æ€æ–‡ä»¶
    location / {
        root /var/www/rogueCultivator/frontend/dist;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    # åç«¯ API ä»£ç†
    location /api {
        proxy_pass http://127.0.0.1:5000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### 5.4 æµ‹è¯•å¹¶é‡è½½ Nginx

```bash
nginx -t                    # æµ‹è¯•é…ç½®
systemctl reload nginx      # é‡è½½é…ç½®
```

---

## 6. å¯†ç ä¿æŠ¤é…ç½®

ä¸ºç½‘ç«™æ·»åŠ  HTTP Basic Auth å¯†ç ä¿æŠ¤ï¼Œé˜²æ­¢æœªæˆæƒè®¿é—®ã€‚

### 6.1 å®‰è£…å·¥å…·å¹¶åˆ›å»ºå¯†ç æ–‡ä»¶

```bash
# å®‰è£… htpasswd å·¥å…·
apt install -y apache2-utils

# åˆ›å»ºå¯†ç æ–‡ä»¶ï¼ˆadmin æ˜¯ç”¨æˆ·åï¼Œæ‰§è¡Œåä¼šæç¤ºè¾“å…¥å¯†ç ï¼‰
htpasswd -c /etc/nginx/.htpasswd admin
```

### 6.2 æ·»åŠ æ–°ç”¨æˆ·æˆ–ä¿®æ”¹å¯†ç 

```bash
# æ·»åŠ æ–°ç”¨æˆ·ï¼ˆä¸å¸¦ -c å‚æ•°ï¼Œå¦åˆ™ä¼šè¦†ç›–æ–‡ä»¶ï¼‰
htpasswd /etc/nginx/.htpasswd æ–°ç”¨æˆ·å

# ä¿®æ”¹ç°æœ‰ç”¨æˆ·å¯†ç 
htpasswd /etc/nginx/.htpasswd admin
```

### 6.3 ä¿®æ”¹ Nginx é…ç½®

åœ¨éœ€è¦ä¿æŠ¤çš„ `location` å—ä¸­æ·»åŠ è®¤è¯é…ç½®ï¼š

```nginx
location / {
    auth_basic "Private Area";
    auth_basic_user_file /etc/nginx/.htpasswd;
    
    root /var/www/rogueCultivator/frontend/dist;
    index index.html;
    try_files $uri $uri/ /index.html;
}

location /api {
    auth_basic "Private Area";
    auth_basic_user_file /etc/nginx/.htpasswd;
    
    proxy_pass http://127.0.0.1:5000;
    # ... å…¶ä»–é…ç½®
}
```

### 6.4 é‡è½½ Nginx

```bash
nginx -t && systemctl reload nginx
```

> **æ³¨æ„ï¼š** ä¿®æ”¹ `.htpasswd` æ–‡ä»¶åä¸éœ€è¦é‡å¯ Nginxï¼Œç«‹å³ç”Ÿæ•ˆã€‚

---

## 7. å¸¸ç”¨è¿ç»´å‘½ä»¤

### 7.1 PM2 ç®¡ç†

```bash
pm2 status                              # æŸ¥çœ‹æ‰€æœ‰è¿›ç¨‹çŠ¶æ€
pm2 logs                                # æŸ¥çœ‹å®æ—¶æ—¥å¿—
pm2 logs --lines 100                    # æŸ¥çœ‹æœ€è¿‘100è¡Œæ—¥å¿—
pm2 restart rogue-cultivator-backend    # é‡å¯åç«¯
pm2 stop rogue-cultivator-backend       # åœæ­¢åç«¯
pm2 delete rogue-cultivator-backend     # åˆ é™¤è¿›ç¨‹
pm2 monit                               # ç›‘æ§é¢æ¿
```

### 7.2 Nginx ç®¡ç†

```bash
nginx -t                    # æµ‹è¯•é…ç½®æ–‡ä»¶è¯­æ³•
systemctl status nginx      # æŸ¥çœ‹çŠ¶æ€
systemctl reload nginx      # é‡è½½é…ç½®ï¼ˆä¸ä¸­æ–­æœåŠ¡ï¼‰
systemctl restart nginx     # é‡å¯æœåŠ¡
systemctl stop nginx        # åœæ­¢æœåŠ¡
```

### 7.3 æ—¥å¿—æŸ¥çœ‹

```bash
# PM2 æ—¥å¿—
tail -f /var/log/pm2/rogue-cultivator-out.log
tail -f /var/log/pm2/rogue-cultivator-error.log

# Nginx æ—¥å¿—
tail -f /var/log/nginx/access.log
tail -f /var/log/nginx/error.log
```

### 7.4 æ›´æ–°éƒ¨ç½²

```bash
# 1. æœ¬åœ°æ‰“åŒ…
npm run build   # å‰ç«¯å’Œåç«¯åˆ†åˆ«æ‰§è¡Œ

# 2. ä¸Šä¼ æ–°æ–‡ä»¶
scp -r frontend/dist root@æœåŠ¡å™¨:/var/www/rogueCultivator/frontend/
scp -r backend/dist root@æœåŠ¡å™¨:/var/www/rogueCultivator/backend/

# 3. é‡å¯åç«¯ï¼ˆå‰ç«¯åªéœ€æ›¿æ¢æ–‡ä»¶ï¼Œæ— éœ€é‡å¯ï¼‰
pm2 restart rogue-cultivator-backend
```

---

## 8. æ•…éšœæ’æŸ¥

### 8.1 502 Bad Gateway

åŸå› ï¼šåç«¯æœåŠ¡æœªè¿è¡Œæˆ–å´©æºƒ

```bash
# æ£€æŸ¥åç«¯çŠ¶æ€
pm2 status
pm2 logs --lines 50

# é‡å¯åç«¯
pm2 restart rogue-cultivator-backend
```

### 8.2 CORS é”™è¯¯

åŸå› ï¼šåç«¯ CORS é…ç½®ä¸æ­£ç¡®

```bash
# æ£€æŸ¥ .env æ–‡ä»¶ä¸­çš„ CORS_ORIGIN
cat /var/www/rogueCultivator/backend/.env

# ä¿®æ”¹åé‡å¯
pm2 restart rogue-cultivator-backend
```

### 8.3 æ•°æ®åº“é”™è¯¯

```bash
# æ£€æŸ¥æ•°æ®åº“æ–‡ä»¶æƒé™
ls -la /var/www/rogueCultivator/backend/data/

# é‡æ–°ç”Ÿæˆ Prisma Client
cd /var/www/rogueCultivator/backend
npx prisma generate
npx prisma db push
```

### 8.4 å‰ç«¯é¡µé¢ç©ºç™½

åŸå› ï¼šå‰ç«¯è¯·æ±‚çš„ API åœ°å€ä¸å¯¹

æ£€æŸ¥ `frontend/.env.production`ï¼š
```env
VITE_API_BASE_URL=/api
```

é‡æ–°æ‰“åŒ…å¹¶ä¸Šä¼ å‰ç«¯ã€‚

### 8.5 Nginx é…ç½®é”™è¯¯

```bash
# æµ‹è¯•é…ç½®
nginx -t

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
tail -50 /var/log/nginx/error.log
```

---

## ğŸ“ å¿«é€Ÿå‚è€ƒå¡ç‰‡

| æ“ä½œ | å‘½ä»¤ |
|------|------|
| æŸ¥çœ‹åç«¯çŠ¶æ€ | `pm2 status` |
| æŸ¥çœ‹åç«¯æ—¥å¿— | `pm2 logs` |
| é‡å¯åç«¯ | `pm2 restart rogue-cultivator-backend` |
| æµ‹è¯• Nginx | `nginx -t` |
| é‡è½½ Nginx | `systemctl reload nginx` |
| ä¿®æ”¹å¯†ç  | `htpasswd /etc/nginx/.htpasswd ç”¨æˆ·å` |
| æŸ¥çœ‹ Nginx é”™è¯¯ | `tail -f /var/log/nginx/error.log` |

---

## ğŸ” å®‰å…¨å»ºè®®

1. **ä½¿ç”¨ HTTPS**ï¼šé…ç½® SSL è¯ä¹¦ï¼Œå¯ç”¨ Let's Encrypt å…è´¹è¯ä¹¦
2. **å¼ºå¯†ç **ï¼šBasic Auth å¯†ç è‡³å°‘ 12 ä½ï¼ŒåŒ…å«å¤§å°å†™å­—æ¯å’Œæ•°å­—
3. **å®šæœŸå¤‡ä»½**ï¼šå¤‡ä»½ SQLite æ•°æ®åº“æ–‡ä»¶
4. **æ›´æ–°ç³»ç»Ÿ**ï¼šå®šæœŸæ‰§è¡Œ `apt update && apt upgrade`
5. **é˜²ç«å¢™**ï¼šåªå¼€æ”¾å¿…è¦ç«¯å£ï¼ˆ80, 443, 22ï¼‰

---

*æ–‡æ¡£åˆ›å»ºæ—¶é—´ï¼š2024å¹´12æœˆ*
*é€‚ç”¨äºï¼šVue 3 + Express + SQLite é¡¹ç›®*
